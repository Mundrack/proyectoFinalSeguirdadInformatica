{% extends "base.html" %}

{% block header %}Evaluaci贸n de Riesgos{% endblock %}
{% block subheader %}Identifique y valore los riesgos inherentes{% endblock %}

{% block content %}
<!-- MERC-PD Scales Information -->
<div class="card"
  style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 1.5rem;">
  <h2 style="color: white;"> Escalas de Valoraci贸n MERC-PD</h2>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
    <div>
      <h3 style="color: white; font-size: 1.1rem; margin-bottom: 0.5rem;">Probabilidad (P)</h3>
      <ul style="line-height: 1.8; font-size: 0.9rem; opacity: 0.95;">
        <li><strong>1 - Muy Baja:</strong> Puede ocurrir solo en circunstancias excepcionales</li>
        <li><strong>2 - Baja:</strong> Podr铆a ocurrir en alg煤n momento</li>
        <li><strong>3 - Media:</strong> Podr铆a ocurrir (ha pasado en el sector)</li>
        <li><strong>4 - Alta:</strong> Probable que ocurra en la mayor铆a de las circunstancias</li>
        <li><strong>5 - Muy Alta:</strong> Se espera que ocurra frecuentemente (casi certeza)</li>
      </ul>
    </div>
    <div>
      <h3 style="color: white; font-size: 1.1rem; margin-bottom: 0.5rem;">Impacto (I)</h3>
      <ul style="line-height: 1.8; font-size: 0.9rem; opacity: 0.95;">
        <li><strong>1 - Insignificante:</strong> Sin impacto legal o interrupci贸n m铆nima</li>
        <li><strong>2 - Menor:</strong> Da帽o reputacional bajo, recuperaci贸n inmediata</li>
        <li><strong>3 - Moderado:</strong> Interrupci贸n de servicios, sanciones administrativas leves</li>
        <li><strong>4 - Mayor:</strong> P茅rdida de datos sensibles, sanciones graves, da帽o reputacional alto</li>
        <li><strong>5 - Catastr贸fico:</strong> Cierre de operaciones, vulneraci贸n masiva de derechos humanos/digitales
        </li>
      </ul>
    </div>
  </div>
  <div
    style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
    <strong>F贸rmula:</strong> Riesgo = Probabilidad  Impacto
  </div>
</div>

<div class="card">
  <h2>Evaluaci贸n de Riesgo Inherente</h2>
  <form method="POST">
    <div class="form-group">
      <label>1. Seleccionar Activo</label>
      <input type="text" id="searchActivo" placeholder=" Buscar activo..."
        style="margin-bottom: 0.5rem; border-color: var(--accent-color);">
      <select name="activo" id="selectActivo" required>
        {% for a in activos %}
        <option value="{{ a.nombre }}"
          data-search="{{ a.nombre|lower }} {{ a.id_manual|lower if  a.id_manual else '' }}">{{ a.nombre }} (Criticidad:
          {{ a.criticidad }})</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label>2. Seleccionar Amenaza</label>
      <input type="text" id="searchAmenaza" placeholder=" Buscar amenaza..."
        style="margin-bottom: 0.5rem; border-color: var(--accent-color);">
      <select name="amenaza" id="selectAmenaza" required>
        {% for t in amenazas %}
        <option value="{{ t.nombre }}" data-search="{{ t.nombre|lower }} {{ t.tipo|lower }}">{{ t.nombre }} ({{ t.tipo
          }})</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label>3. Vulnerabilidad (Debilidad explotada)</label>
      <textarea name="vulnerabilidad" rows="2" placeholder="Ej. Falta de parches, configuraci贸n por defecto..."
        required></textarea>
    </div>

    <div class="form-group">
      <label>4. Controles Existentes</label>
      <textarea name="controles" rows="2" placeholder="Ej. Antivirus b谩sico, Firewall perimetral..."></textarea>
    </div>

    <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
      <div>
        <label>Probabilidad (1-5)</label>
        <input type="number" name="probabilidad" min="1" max="5" required>
      </div>
      <div>
        <label>Impacto (1-5)</label>
        <input type="number" name="impacto" min="1" max="5" required>
      </div>
    </div>

    <button type="submit">Evaluar Riesgo</button>
  </form>
</div>

<div class="card">
  <h2>Riesgos Evaluados</h2>
  <table>
    <thead>
      <tr>
        <th>Activo</th>
        <th>Amenaza</th>
        <th>Probabilidad</th>
        <th>Impacto</th>
        <th>Nivel</th>
      </tr>
    </thead>
    <tbody>
      {% for r in riesgos %}
      <tr>
        <td>{{ r.activo }}</td>
        <td>{{ r.amenaza }}</td>
        <td>{{ r.probabilidad }}</td>
        <td>{{ r.impacto }}</td>
        <td><span
            class="badge badge-{{ 'critical' if r.nivel == 'Cr铆tico' else 'high' if r.nivel == 'Alto' else 'medium' if r.nivel == 'Medio' else 'low' }}">{{
            r.nivel }}</span></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  // Filter logic for Selects in Evaluation Form
  const searchActivo = document.getElementById('searchActivo');
  const selectActivo = document.getElementById('selectActivo');
  const searchAmenaza = document.getElementById('searchAmenaza');
  const selectAmenaza = document.getElementById('selectAmenaza');

  function filterSelect(input, select) {
    const filter = input.value.toLowerCase();
    const options = select.options;

    for (let i = 0; i < options.length; i++) {
      const text = options[i].getAttribute('data-search') || options[i].text.toLowerCase();
      if (text.includes(filter)) {
        options[i].style.display = "";
      } else {
        options[i].style.display = "none";
      }
    }
  }

  searchActivo?.addEventListener('input', () => filterSelect(searchActivo, selectActivo));
  searchAmenaza?.addEventListener('input', () => filterSelect(searchAmenaza, selectAmenaza));
</script>
{% endblock %}