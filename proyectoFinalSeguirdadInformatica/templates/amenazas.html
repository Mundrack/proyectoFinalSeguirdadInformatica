{% extends "base.html" %}

{% block header %}Cat√°logo de Amenazas{% endblock %}
{% block subheader %}Identifique amenazas potenciales para sus activos{% endblock %}

{% block content %}
<div class="grid-3" style="grid-template-columns: 1fr 2fr;">
  <div class="card">
    <h2>‚ö†Ô∏è Nueva Amenaza</h2>
    <form method="POST">
      <div class="form-group">
        <label>Nombre de la Amenaza</label>
        <input type="text" name="nombre" placeholder="Ej. Ransomware, Incendio..." required>
      </div>

      <div class="form-group">
        <label>Tipo</label>
        <select name="tipo">
          <option value="Cibercrimen">Cibercrimen</option>
          <option value="Errores Humanos">Errores Humanos</option>
          <option value="F√≠sicas">F√≠sicas</option>
        </select>
      </div>

      <div class="form-group">
        <label>Activo Afectado</label>
        <select name="activo">
          {% for a in activos %}
          <option value="{{ a.nombre }}">{{ a.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <button type="submit" style="width: 100%;">Registrar Amenaza</button>
    </form>
  </div>

  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h2 style="margin: 0;">Amenazas Registradas</h2>
      <div style="display: flex; gap: 0.75rem; align-items: center;">
        <input type="text" id="searchAmenazas" placeholder="üîç Buscar amenaza..."
          style="width: 220px; padding: 0.5rem; font-size: 0.9rem;">
        <select id="filterTipo" style="padding: 0.5rem; font-size: 0.9rem;">
          <option value="">Todos los tipos</option>
          <option value="Cibercrimen">Cibercrimen</option>
          <option value="Errores Humanos">Errores Humanos</option>
          <option value="F√≠sicas">F√≠sicas</option>
        </select>
      </div>
    </div>
    {% if amenazas %}
    <table id="amenazasTable">
      <thead>
        <tr>
          <th>Amenaza</th>
          <th>Tipo</th>
          <th>Activo Afectado</th>
        </tr>
      </thead>
      <tbody>
        {% for t in amenazas %}
        <tr data-nombre="{{ t.nombre|lower }}" data-tipo="{{ t.tipo }}">
          <td>{{ t.nombre }}</td>
          <td><span class="badge badge-{{ 'low' if t.tipo == 'Interna' else 'high' }}">{{ t.tipo }}</span></td>
          <td>{{ t.activo }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div id="noResultsAmenazas" style="display: none; text-align: center; padding: 2rem; color: var(--text-muted);">
      <p style="font-size: 1.1rem;">üîç No se encontraron amenazas con esos criterios</p>
    </div>
    {% else %}
    <p style="color: var(--text-muted); text-align: center; padding: 2rem;">No hay amenazas registradas a√∫n.</p>
    {% endif %}
  </div>
</div>

<script>
  // Real-time search and filter for threats
  const searchAmenazas = document.getElementById('searchAmenazas');
  const filterTipo = document.getElementById('filterTipo');
  const amenazasRows = document.querySelectorAll('#amenazasTable tbody tr');
  const noResultsAmenazas = document.getElementById('noResultsAmenazas');
  const amenazasTable = document.getElementById('amenazasTable');

  function filterAmenazas() {
    if (!amenazasRows || amenazasRows.length === 0) return;

    const searchTerm = searchAmenazas.value.toLowerCase();
    const tipoFilter = filterTipo.value;

    let visibleCount = 0;

    amenazasRows.forEach(row => {
      const nombre = row.dataset.nombre;
      const tipo = row.dataset.tipo;

      const matchesSearch = nombre.includes(searchTerm);
      const matchesTipo = !tipoFilter || tipo === tipoFilter;

      if (matchesSearch && matchesTipo) {
        row.style.display = '';
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });

    if (visibleCount === 0) {
      amenazasTable.style.display = 'none';
      noResultsAmenazas.style.display = 'block';
    } else {
      amenazasTable.style.display = 'table';
      noResultsAmenazas.style.display = 'none';
    }
  }

  searchAmenazas?.addEventListener('input', filterAmenazas);
  filterTipo?.addEventListener('change', filterAmenazas);
</script>
{% endblock %}